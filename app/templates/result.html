{% extends "base.html" %}

{% block content %}
  <div class="nav">
    <div class="brand">
      <a href="/" class="brand-link">
        <img
          src="/static/icon-64.png"
          srcset="/static/icon-128.png 2x, /static/icon-512.png 3x"
          alt="C"
          class="brand-logo"
          width="28"
          height="28"
        />
        <span class="brand-text">CashGuard</span>
      </a>
    </div>

    <!-- ✅ aynı sektörde tekrar test -->
    <a class="btn secondary" href="/check?sector={{ sector }}">Tekrar Test</a>
  </div>

  <div class="card">
    <h2>Sonuç — {{ sector_label }}</h2>
    <p><strong>cashguardtr.com</strong> — Skor ve risk seviyen aşağıda.</p>
    <hr>

    <p><span class="badge {{ level }}">{{ level }}</span></p>
    <h1>{{ score }}/100</h1>

    <h3>Öne çıkan başlıklar</h3>
    <ul class="list">
      {% for msg in messages %}
        <li>{{ msg }}</li>
      {% endfor %}
    </ul>

    {% if score < 60 %}
      <div class="callout">
        <h3>⚠️ Nakitiniz korunmuyor</h3>
        <p>İsterseniz 5 dakikalık ücretsiz online görüşme yapalım. Hızlıca en kritik 2 aksiyonu belirleyelim.</p>

        <div class="pills">
          <a class="pill" href="https://wa.me/905316323779" target="_blank">WhatsApp ile yaz</a>
          <a class="pill" href="https://YOUR-ZOOM-BOOKING-LINK" target="_blank">Zoom randevusu al</a>
          <a class="pill" href="mailto:info@cashguardtr.com?subject=CashGuardTR%20%3C60%20Skor%20-%205%20dk%20g%C3%B6r%C3%BC%C5%9Fme">E-posta</a>
        </div>

        <p class="small" style="margin-top:10px;">
          Not: Bu test hızlı ön taramadır. Detaylı analiz için nakit akışı & vade planı çıkarırız.
        </p>
      </div>
    {% else %}
      <div class="callout">
        <h3>✅ Tebrikler</h3>
        <p>Nakit yönetiminiz şu an yeterli görünüyor. İşlerin kötü gittiğini düşündüğünüz zaman testi tekrar yapın ve bizimle iletişime geçin.</p>

        <div class="pills">
          <a class="pill" href="/check?sector={{ sector }}">Testi tekrar yap</a>
          <a class="pill" href="mailto:info@cashguardtr.com?subject=CashGuardTR%20%3E%3D60%20Skor%20-%20Bilgi">İletişime geç</a>
        </div>
      </div>
    {% endif %}

    <hr>

    <!-- =========================
         PDF RAPORU İNDİR (KALDIRILDI)
         YERİNE: MAIL İLE GÖNDER
         ========================= -->
    <h3>Sonucunu e-posta ile al</h3>
    <p class="small">PDF raporun mailine ekli olarak gönderilecek. (İletim kaydı rapor@cashguardtr.com adresine düşer.)</p>

    {% if email_sent %}
      <div class="callout">
        <h3>✅ Gönderildi</h3>
        <p>Raporunuz <strong>{{ email_to }}</strong> adresine iletildi.</p>
      </div>
    {% endif %}

    {% if email_error %}
      <div class="callout">
        <h3>⚠️ Gönderilemedi</h3>
        <p class="small">Hata: {{ email_error }}</p>
        <p class="small">Lütfen tekrar deneyin veya WhatsApp’tan yazın.</p>
      </div>
    {% endif %}

    <form action="/result/email" method="post">
      <div class="field" style="max-width:420px;">
        <label>E-posta adresiniz</label>
        <input type="email" name="email" placeholder="ornek@firma.com" required>
      </div>

      <div class="field" style="max-width:420px;">
        <label>Firma adı (opsiyonel)</label>
        <input type="text" name="company" placeholder="Örn: ABC Savunma Sanayi A.Ş.">
      </div>

      <!-- ✅ Hidden: sektör + sonuç girdileri -->
      <input type="hidden" name="sector" value="{{ sector }}">

      <input type="hidden" name="collection_days" value="{{ collection_days }}">
      <input type="hidden" name="payable_days" value="{{ payable_days }}">
      <input type="hidden" name="fx_debt_ratio" value="{{ fx_debt_ratio }}">
      <input type="hidden" name="fx_revenue_ratio" value="{{ fx_revenue_ratio }}">
      <input type="hidden" name="cash_buffer_months" value="{{ cash_buffer_months }}">
      <input type="hidden" name="top_customer_share" value="{{ top_customer_share }}">

      <input type="hidden" name="top_customer_2m_gap_month" value="{{ top_customer_2m_gap_month }}">
      <input type="hidden" name="unplanned_deferral_12m" value="{{ unplanned_deferral_12m }}">

      <input type="hidden" name="delay_issue" value="{{ delay_issue }}">
      <input type="hidden" name="short_debt_ratio" value="{{ short_debt_ratio }}">
      <input type="hidden" name="limit_pressure" value="{{ limit_pressure }}">
      <input type="hidden" name="hedging" value="{{ hedging }}">

      <div class="actions">
        <button class="btn" type="submit">Raporu Mailime Gönder</button>
        <a class="btn secondary" href="/">Ana Sayfa</a>
        <a class="btn secondary" href="/check?sector={{ sector }}">Yeni Test</a>
      </div>
    </form>

    <p class="small">Sonraki adım: otomatik aksiyon planı + rapor.</p>
  </div>
{% endblock %}
